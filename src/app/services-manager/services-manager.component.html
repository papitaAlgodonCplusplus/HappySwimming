<!-- src/app/services-manager/services-manager.component.html (Updated - Fixed and Variable Pricing Support) -->
<app-header></app-header>

<div class="services-manager-container">
  <div class="page-header">
    <h1 class="page-title">{{ 'servicesManager.title' | translate }}</h1>
    <p class="page-subtitle">
      {{ userRole === 'client' ? ('servicesManager.clientSubtitle' | translate) :
      ('servicesManager.professionalSubtitle' | translate) }}
    </p>
    <div *ngIf="userClientName" class="client-info">
      <span class="client-badge">{{ userClientName }}</span>
    </div>
  </div>

  <!-- Error and Success Messages -->
  <div *ngIf="error" class="alert alert-error">
    <span class="alert-icon">⚠️</span>
    <span class="alert-message">{{ error }}</span>
    <button class="alert-close" (click)="clearMessages()">×</button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    <span class="alert-icon">✅</span>
    <span class="alert-message">{{ successMessage }}</span>
    <button class="alert-close" (click)="clearMessages()">×</button>
  </div>

  <!-- Refresh Button -->
  <div class="action-bar">
    <button class="btn btn-secondary" (click)="refreshData()" [disabled]="isLoading">
      <span class="btn-icon">🔄</span>
      {{ 'servicesManager.refresh' | translate }}
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && availableCourses.length === 0" class="loading-container">
    <div class="loading-spinner-large"></div>
    <p>{{ 'servicesManager.loadingCourses' | translate }}</p>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Available Courses Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">{{ 'servicesManager.availableCourses' | translate }}</h2>
        <span class="course-count">{{ availableCourses.length }} {{ 'servicesManager.coursesAvailable' | translate
          }}</span>
      </div>

      <!-- No courses available -->
      <div *ngIf="!isLoading && availableCourses.length === 0" class="empty-state">
        <div class="empty-icon">📚</div>
        <h3>{{ 'servicesManager.noCourses' | translate }}</h3>
        <p *ngIf="userRole === 'client'">{{ 'servicesManager.noCoursesClientMessage' | translate }}</p>
        <p *ngIf="userRole === 'professional'">{{ 'servicesManager.noCoursesProfessionalMessage' | translate }}</p>
        <p *ngIf="userClientName" class="client-note">
          {{ 'servicesManager.coursesForClient' | translate }}: <strong>{{ userClientName }}</strong>
        </p>
      </div>

      <!-- Courses Grid -->
      <div *ngIf="availableCourses.length > 0" class="courses-grid">
        <div *ngFor="let course of availableCourses; trackBy: trackByCourseId" class="course-card">
          <!-- Course Header -->
          <div class="course-header">
            <h3 class="course-title">{{ course.name }}</h3>
            <div *ngIf="course.courseCode" class="course-code">{{ course.courseCode }}</div>
          </div>

          <!-- Enrollment Status Badge -->
          <div *ngIf="getEnrollmentStatus(course.id)" class="enrollment-status-badge">
            <span class="status-badge" [ngClass]="getStatusClass(getEnrollmentStatus(course.id)!)">
              {{ getLocalizedStatus(getEnrollmentStatus(course.id)!) }}
            </span>
          </div>

          <!-- Course Info -->
          <div class="course-info">
            <!-- Client name -->
            <div class="info-row">
              <span class="info-label">{{ 'servicesManager.client' | translate }}:</span>
              <span class="info-value">{{ course.clientName }}</span>
            </div>

            <!-- Professional assignment -->
            <div class="info-row">
              <span class="info-label">{{ 'servicesManager.professional' | translate }}:</span>
              <span class="info-value">{{ course.professionalName || ('servicesManager.notAssigned' | translate)
                }}</span>
            </div>

            <!-- Schedule Section -->
            <div class="schedule-section">
              <div class="info-row">
                <span class="info-label">{{ 'servicesManager.schedule' | translate }}:</span>
              </div>
              <div class="schedule-controls">
                <div class="schedule-time-group">
                  <label class="schedule-label">{{ 'servicesManager.startTime' | translate }}:</label>
                  <select class="schedule-select" [(ngModel)]="course.startTime"
                    (change)="onScheduleChange(course.id, 'startTime', course.startTime ?? '')">
                    <option value="">{{ 'servicesManager.selectTime' | translate }}</option>
                    <option *ngFor="let time of getTimeOptions()" [value]="time.value"
                      [selected]="!course.startTime && time.value === '9:00'">
                      {{ time.label }}
                    </option>
                  </select>
                </div>
                <div class="schedule-time-group">
                  <label class="schedule-label">{{ 'servicesManager.endTime' | translate }}:</label>
                  <select class="schedule-select" [(ngModel)]="course.endTime"
                    (change)="onScheduleChange(course.id, 'endTime', course.endTime ?? '')">
                    <option value="">{{ 'servicesManager.selectTime' | translate }}</option>
                    <option *ngFor="let time of getTimeOptions()" [value]="time.value"
                      [selected]="!course.endTime && time.value === '10:00'">
                      {{ time.label }}
                    </option>
                  </select>
                </div>
              </div>
              <!-- Display selected schedule -->
              <div *ngIf="course.startTime && course.endTime" class="schedule-display">
                <span class="schedule-time">{{ formatTimeDisplay(course.startTime) }} - {{
                  formatTimeDisplay(course.endTime) }}</span>
              </div>
            </div>

            <!-- Duration -->
            <div class="info-row">
              <span class="info-label">{{ 'servicesManager.duration' | translate }}:</span>
              <span class="info-value">{{ getCourseDuration(course) }}</span>
            </div>

            <!-- Enrollment info -->
            <div class="info-row">
              <span class="info-label">{{ 'servicesManager.enrollment' | translate }}:</span>
              <span class="info-value">{{ course.currentStudents || 0 }}/{{ course.maxStudents || 6 }} {{
                'servicesManager.students' | translate }}</span>
            </div>

            <!-- Availability -->
            <div class="info-row">
              <span class="info-label">{{ 'servicesManager.availability' | translate }}:</span>
              <span class="info-value" [ngClass]="hasAvailableSpots(course) ? 'text-success' : 'text-danger'">
                {{ hasAvailableSpots(course) ? (course.availableSpots + ' ' + ('servicesManager.spotsAvailable' |
                translate)) : ('servicesManager.courseFull' | translate) }}
              </span>
            </div>
          </div>

          <!-- Course Description -->
          <div class="course-description">
            <p>{{ getCourseDescription(course) }}</p>
          </div>

          <!-- Pricing Information - Updated for Fixed/Variable Pricing -->
          <div class="course-pricing">
            <div *ngIf="course.pricing && course.pricing.length > 0" class="pricing-details">

              <!-- Fixed Pricing Display -->
              <div *ngIf="isFixedPricingCourse(course)" class="fixed-pricing-display">
                <div class="pricing-type-badge fixed-pricing">
                  {{ 'servicesManager.fixedPricing' | translate }}
                </div>
                <div class="fixed-price-main">
                  <span class="price-label">{{ 'servicesManager.price' | translate }}:</span>
                  <span class="price-value">€{{ course.pricing[0].price }}</span>
                </div>
                <div class="fixed-price-details">
                  {{ course.pricing[0].lessonsCount }} {{ 'servicesManager.lessons' | translate }}
                  - {{ 'servicesManager.sameForAllStudents' | translate }}
                </div>
              </div>

              <!-- Variable Pricing Display -->
              <div *ngIf="!isFixedPricingCourse(course)" class="variable-pricing-display">
                <div class="pricing-type-badge variable-pricing">
                  {{ 'servicesManager.variablePricing' | translate }}
                </div>
                <div class="pricing-note">{{ getPricingDetails(course) }}</div>
                <div class="pricing-structure">
                  <h4>{{ 'servicesManager.pricingStructure' | translate }}</h4>
                  <div class="pricing-list">
                    <div *ngFor="let pricing of course.pricing" class="pricing-item">
                      <span class="pricing-students">{{ pricing.studentCount }}{{ pricing.studentCount === 1 ? (' ' +
                        ('servicesManager.student' | translate)) : (' ' + ('servicesManager.students' | translate))
                        }}</span>
                      <span class="pricing-amount">€{{ pricing.price }} ({{ pricing.lessonsCount }} {{
                        'servicesManager.lessons' | translate }})</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Course Actions -->
          <div class="course-actions">
            <!-- If enrolled - show enrollment details button -->
            <div *ngIf="getEnrollmentStatus(course.id)">
              <button class="btn btn-info" (click)="showEnrollmentDetails(course)" [disabled]="isLoading">
                <span class="btn-icon">📋</span>
                {{ 'servicesManager.enrollmentDetails' | translate }}
              </button>
            </div>
            <br />
            <button *ngIf="hasAvailableSpots(course)" class="btn btn-primary" (click)="selectCourse(course)"
              [disabled]="isLoading">
              <span class="btn-icon">📝</span>
              {{ 'servicesManager.enroll' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Enrollment Form Modal -->
  <div *ngIf="showEnrollmentForm" class="modal-overlay" (click)="cancelEnrollment()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ 'servicesManager.enrollInCourse' | translate }}</h2>
        <button class="modal-close" (click)="cancelEnrollment()">×</button>
      </div>

      <div class="modal-body">
        <div *ngIf="selectedCourse" class="selected-course-info">
          <h3>{{ selectedCourse.name }}</h3>
          <p>{{ selectedCourse.description }}</p>
          <div class="course-details-modal">
            <div class="modal-detail">
              <strong>{{ 'servicesManager.client' | translate }}:</strong> {{ selectedCourse.clientName }}
            </div>
            <div class="modal-detail">
              <strong>{{ 'servicesManager.professional' | translate }}:</strong> {{ selectedCourse.professionalName }}
            </div>
            <div class="modal-detail">
              <strong>{{ 'servicesManager.duration' | translate }}:</strong> {{ getCourseDuration(selectedCourse) }}
            </div>
            <div class="modal-detail">
              <strong>{{ 'servicesManager.availability' | translate }}:</strong> {{ selectedCourse.availableSpots }} {{
              'servicesManager.spotsLeft' | translate }}
            </div>
          </div>

          <!-- Pricing Display in Modal - Updated for Fixed/Variable -->
          <div class="course-price-modal">
            <div *ngIf="isFixedPricingCourse(selectedCourse)" class="fixed-price-modal">
              <div class="price-main">€{{ selectedCourse.pricing![0].price }}</div>
              <div class="price-details">{{ selectedCourse.pricing![0].lessonsCount }} {{ 'servicesManager.lessons' |
                translate }}</div>
              <div class="price-note">{{ 'servicesManager.fixedPriceNote' | translate }}</div>
            </div>
            <div *ngIf="!isFixedPricingCourse(selectedCourse)" class="variable-price-modal">
              <div class="price-main">{{ getCoursePrice(selectedCourse) }}</div>
              <div class="price-note">{{ getPricingDetails(selectedCourse) }}</div>
            </div>
          </div>
        </div>

        <form class="enrollment-form" (ngSubmit)="enrollInCourse()">
          <!-- Child name (required for all courses) -->
          <div class="form-group">
            <label for="kidName">{{ 'servicesManager.childName' | translate }} *</label>
            <input type="text" id="kidName" [(ngModel)]="enrollmentForm.kidName" name="kidName" required
              class="form-control" placeholder="{{ 'servicesManager.enterChildName' | translate }}">
          </div>

          <!-- Mother contact (required for all courses) -->
          <div class="form-group">
            <label for="motherContact">{{ 'servicesManager.motherContact' | translate }} *</label>
            <input type="text" id="motherContact" [(ngModel)]="enrollmentForm.motherContact" name="motherContact"
              required class="form-control" placeholder="{{ 'servicesManager.enterMotherContact' | translate }}">
          </div>

          <div class="form-group">
            <label for="motherPhone">{{ 'servicesManager.motherPhone' | translate }} *</label>
            <input type="text" id="motherPhone" [(ngModel)]="enrollmentForm.motherPhone" name="motherPhone" required
              class="form-control" placeholder="{{ 'servicesManager.motherPhone' | translate }}">
          </div>

          <div class="form-group">
            <label for="motherEmail">{{ 'servicesManager.motherEmail' | translate }} *</label>
            <input type="text" id="motherEmail" [(ngModel)]="enrollmentForm.motherEmail" name="motherEmail" required
              class="form-control" placeholder="{{ 'servicesManager.motherEmail' | translate }}">
          </div>

          <!-- Payment button with calculated price-->
          <button type="button" id="paymentButton" class="pay-now-button" (click)="openPaymentLink()">
            {{ 'servicesManager.payNow' | translate }}
          </button>

          <!-- Notes (optional) -->
          <div class="form-group">
            <label for="notes">{{ 'servicesManager.notes' | translate }}</label>
            <textarea id="notes" [(ngModel)]="enrollmentForm.notes" name="notes" class="form-control"></textarea>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="cancelEnrollment()" [disabled]="isLoading">
              {{ 'servicesManager.cancel' | translate }}
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <span *ngIf="isLoading" class="loading-spinner"></span>
              {{ 'servicesManager.confirmEnrollment' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Enrollment Details Modal -->
  <div *ngIf="showEnrollmentDetailsModal" class="modal-overlay" (click)="closeEnrollmentDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ 'servicesManager.enrollmentDetails' | translate }}</h2>
        <button class="modal-close" (click)="closeEnrollmentDetails()">×</button>
      </div>

      <div class="modal-body">
        <div *ngIf="selectedEnrollment" class="enrollment-details-content">
          <!-- Course Information -->
          <div class="details-section">
            <h3>{{ 'servicesManager.courseInformation' | translate }}</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">{{ 'servicesManager.courseName' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.courseName }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">{{ 'servicesManager.status' | translate }}:</span>
                <span class="status-badge" [ngClass]="getStatusClass(selectedEnrollment.status)">
                  {{ getLocalizedStatus(selectedEnrollment.status) }}
                </span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.professionalName">
                <span class="detail-label">{{ 'servicesManager.professional' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.professionalName }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">{{ 'servicesManager.price' | translate }}:</span>
                <span class="detail-value">€{{ selectedEnrollment.price }}</span>
              </div>
            </div>
          </div>

          <!-- Student Information -->
          <div class="details-section">
            <h3>{{ 'servicesManager.studentInformation' | translate }}</h3>
            <div class="detail-grid">
              <div class="detail-item" *ngIf="selectedEnrollment.kidName">
                <span class="detail-label">{{ 'servicesManager.childName' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.kidName }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.motherContact">
                <span class="detail-label">{{ 'servicesManager.motherContact' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.motherContact }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.motherPhone">
                <span class="detail-label">{{ 'servicesManager.motherPhone' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.motherPhone }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.motherEmail">
                <span class="detail-label">{{ 'servicesManager.motherEmail' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.motherEmail }}</span>
              </div>
            </div>
          </div>

          <!-- Dates Information -->
          <div class="details-section">
            <h3>{{ 'servicesManager.datesInformation' | translate }}</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">{{ 'servicesManager.enrollmentDate' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.enrollmentDate | date:'short' }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.startDate">
                <span class="detail-label">{{ 'servicesManager.startDate' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.startDate | date:'short' }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedEnrollment.endDate">
                <span class="detail-label">{{ 'servicesManager.endDate' | translate }}:</span>
                <span class="detail-value">{{ selectedEnrollment.endDate | date:'short' }}</span>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="details-section" *ngIf="selectedEnrollment.notes">
            <h3>{{ 'servicesManager.notes' | translate }}</h3>
            <p class="notes-content">{{ selectedEnrollment.notes }}</p>
          </div>

          <!-- Actions -->
          <div class="enrollment-details-actions">
            <!-- Payment button - only show if status is pending -->
            <button *ngIf="selectedEnrollment.status === 'pending'" type="button" class="pay-now-button"
              (click)="openPaymentLink()">
              <span class="btn-icon">💳</span>
              {{ 'servicesManager.payNow' | translate }}
            </button>

            <!-- Cancel button - only show if status is pending -->
            <button *ngIf="selectedEnrollment.status === 'pending'" class="btn btn-danger"
              (click)="cancelEnrollmentFromDetails()" [disabled]="isLoading">
              <span class="btn-icon">❌</span>
              {{ 'servicesManager.cancelEnrollment' | translate }}
            </button>

            <!-- Close button -->
            <button class="btn btn-secondary" (click)="closeEnrollmentDetails()">
              <span class="btn-icon">✖️</span>
              {{ 'servicesManager.close' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>