<!-- src/app/admin-course-management/admin-course-management.component.html (Updated with Translations) -->
<app-header></app-header>

<div class="course-management-container">
  <div class="page-header">
    <h1 class="page-title">{{ 'adminCourseManagement.title' | translate }}</h1>
    <p class="page-subtitle">{{ 'adminCourseManagement.subtitle' | translate }}</p>
  </div>

  <!-- Error and Success Messages -->
  <div *ngIf="error" class="alert alert-error">
    <span class="alert-icon">⚠️</span>
    <span class="alert-message">{{ error }}</span>
    <button class="alert-close" (click)="clearMessages()">×</button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    <span class="alert-icon">✅</span>
    <span class="alert-message">{{ successMessage }}</span>
    <button class="alert-close" (click)="clearMessages()">×</button>
  </div>

  <!-- Access Denied for Non-Admin Users -->
  <div *ngIf="!isAdmin" class="access-denied">
    <h2>{{ 'adminCourseManagement.accessDenied' | translate }}</h2>
    <p>{{ 'adminCourseManagement.adminRequired' | translate }}</p>
  </div>

  <!-- Admin Course Management Interface -->
  <div *ngIf="isAdmin" class="admin-interface">
    <!-- Action Bar -->
    <div class="action-bar">
      <button class="btn btn-primary" (click)="toggleCreateForm()" [disabled]="isLoading">
        <span class="btn-icon">{{ showCreateForm ? '×' : '+' }}</span>
        {{ showCreateForm ? ('adminCourseManagement.cancelCreate' | translate) : ('adminCourseManagement.createCourse' | translate) }}
      </button>

      <div class="action-stats">
        <span class="stat-item">
          {{ 'adminCourseManagement.totalCourses' | translate }}: {{ courses.length }}
        </span>
      </div>
    </div>

    <!-- Create/Edit Course Form -->
    <div *ngIf="showCreateForm" class="course-form-container">
      <div class="form-header">
        <h2>{{ editingCourse ? ('adminCourseManagement.editCourse' | translate) : ('adminCourseManagement.createNewCourse' | translate) }}</h2>
        <p class="form-subtitle">{{ 'adminCourseManagement.formSubtitle' | translate }}</p>

        <!-- Course Template Selection -->
        <div *ngIf="!editingCourse" class="template-selection-section">
          <button type="button" class="btn btn-secondary btn-template" (click)="showCourseTemplateSelection()">
            <span class="btn-icon">📋</span>
            {{ 'adminCourseManagement.useExistingTemplate' | translate }}
          </button>
        </div>
      </div>

      <form class="course-form" (ngSubmit)="editingCourse ? updateCourse() : createCourse()">
        <!-- Basic Course Information -->
        <div class="form-section">
          <h3 class="section-title">{{ 'adminCourseManagement.basicInfo' | translate }}</h3>

          <div class="form-grid">
            <div class="form-group">
              <label for="courseName">{{ 'adminCourseManagement.courseName' | translate }} *</label>
              <input type="text" id="courseName" [(ngModel)]="courseForm.name" name="courseName"
                placeholder="e.g., SWIM A STORY" required class="form-control">
            </div>

            <div class="form-group">
              <label for="clientName">{{ 'adminCourseManagement.clientName' | translate }} *</label>
              <select id="clientName" [(ngModel)]="courseForm.clientName" name="clientName" required class="form-control">
                <option value="">{{ 'adminCourseManagement.selectClient' | translate }}...</option>
                <option *ngFor="let client of clients" [value]="getClientDisplayName(client)">
                  {{ getClientDisplayName(client) }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="description">{{ 'adminCourseManagement.description' | translate }} *</label>
            <textarea id="description" [(ngModel)]="courseForm.description" name="description" rows="4"
              placeholder="{{ 'adminCourseManagement.descriptionPlaceholder' | translate }}" required class="form-control"></textarea>
          </div>
        </div>

        <!-- Course Duration -->
        <div class="form-section">
          <h3 class="section-title">{{ 'adminCourseManagement.courseDuration' | translate }}</h3>
          <p class="section-subtitle">{{ 'adminCourseManagement.courseDurationSubtitle' | translate }}</p>

          <div class="form-grid">
            <div class="form-group">
              <label for="startDate">{{ 'adminCourseManagement.startDate' | translate }} *</label>
              <input type="date" id="startDate" [(ngModel)]="courseForm.startDate" name="startDate" required class="form-control">
            </div>

            <div class="form-group">
              <label for="endDate">{{ 'adminCourseManagement.endDate' | translate }} *</label>
              <input type="date" id="endDate" [(ngModel)]="courseForm.endDate" name="endDate" required class="form-control">
            </div>
          </div>
        </div>

        <!-- Professional Assignment -->
        <div class="form-section">
          <h3 class="section-title">{{ 'adminCourseManagement.professionalAssignment' | translate }}</h3>

          <div class="form-group">
            <label for="professionalId">{{ 'adminCourseManagement.assignProfessional' | translate }} *</label>
            <select id="professionalId" [(ngModel)]="courseForm.professionalId" name="professionalId" required class="form-control">
              <option value="">{{ 'adminCourseManagement.selectProfessional' | translate }}</option>
              <option *ngFor="let professional of professionals" [value]="professional.id">
                {{ professional.name }} - {{ professional.specialties.join(', ') }}
              </option>
            </select>
          </div>
        </div>

        <!-- Group Pricing Structure -->
        <div class="form-section">
          <h3 class="section-title">{{ 'adminCourseManagement.groupPricingStructure' | translate }}</h3>
          <p class="section-subtitle">{{ 'adminCourseManagement.groupPricingSubtitle' | translate }}</p>

          <div class="group-pricing-container">
            <div class="pricing-group-card">
              <h4 class="pricing-group-title">1-4 {{ 'adminCourseManagement.students' | translate }}</h4>
              <div class="form-group">
                <label for="groupPrice1-4">{{ 'adminCourseManagement.pricePerStudent' | translate }} *</label>
                <input type="number" id="groupPrice1-4" [ngModel]="getGroupPricingValue('1-4')"
                  (ngModelChange)="updateGroupPricing('1-4', $event)" name="groupPrice1-4" min="0" step="0.01" required
                  class="form-control" placeholder="0.00">
              </div>
            </div>

            <div class="pricing-group-card">
              <h4 class="pricing-group-title">5-6 {{ 'adminCourseManagement.students' | translate }}</h4>
              <div class="form-group">
                <label for="groupPrice5-6">{{ 'adminCourseManagement.pricePerStudent' | translate }} *</label>
                <input type="number" id="groupPrice5-6" [ngModel]="getGroupPricingValue('5-6')"
                  (ngModelChange)="updateGroupPricing('5-6', $event)" name="groupPrice5-6" min="0" step="0.01" required
                  class="form-control" placeholder="0.00">
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Management -->
        <div class="form-section schedule-management-section">
          <h3 class="section-title">{{ 'adminCourseManagement.courseSchedules' | translate }}</h3>
          <p class="section-subtitle">{{ 'adminCourseManagement.courseSchedulesSubtitle' | translate }}</p>

          <!-- Add New Schedule -->
          <div class="schedule-add-section">
            <h4>{{ 'adminCourseManagement.addNewSchedule' | translate }}</h4>

            <!-- Schedule Time Selection -->
            <div class="schedule-time-section">
              <div class="form-grid">
                <div class="form-group">
                  <label for="newStartTime">{{ 'adminCourseManagement.startTime' | translate }} *</label>
                  <select id="newStartTime" [(ngModel)]="newSchedule.startTime" name="newStartTime" class="form-control">
                    <option value="">{{ 'adminCourseManagement.selectTime' | translate }}</option>
                    <option *ngFor="let time of getTimeOptions()" [value]="time.value">{{ time.label }}</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="newEndTime">{{ 'adminCourseManagement.endTime' | translate }} *</label>
                  <select id="newEndTime" [(ngModel)]="newSchedule.endTime" name="newEndTime" class="form-control">
                    <option value="">{{ 'adminCourseManagement.selectTime' | translate }}</option>
                    <option *ngFor="let time of getTimeOptions()" [value]="time.value">{{ time.label }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Schedule Preview -->
            <div *ngIf="newSchedule.startTime && newSchedule.endTime" class="schedule-preview styled-preview">
              <p class="preview-text">
                {{ 'adminCourseManagement.schedule' | translate }}: <strong>{{ formatTimeDisplay(newSchedule.startTime) }} - {{ formatTimeDisplay(newSchedule.endTime) }}</strong>
              </p>
            </div>
          </div>

          <!-- Lesson Options for New Schedule -->
          <div class="lesson-options-section">
            <h5>{{ 'adminCourseManagement.lessonOptionsForSchedule' | translate }}</h5>

            <!-- Add Lesson Option -->
            <div class="lesson-option-add">
              <div class="form-grid">
                <div class="form-group">
                  <label for="newLessonCount">{{ 'adminCourseManagement.numberOfLessons' | translate }} *</label>
                  <select id="newLessonCount" [(ngModel)]="newLessonOption.lessonCount" name="newLessonCount" class="form-control">
                    <option *ngFor="let count of getLessonCountOptions()" [value]="count">
                      {{ count }} {{ count === 1 ? ('adminCourseManagement.lesson' | translate) : ('adminCourseManagement.lessons' | translate) }}
                    </option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="newLessonPrice">
                    {{ 'adminCourseManagement.priceForLessons' | translate }} {{ newLessonOption.lessonCount }} 
                    {{ newLessonOption.lessonCount > 1 ? ('adminCourseManagement.lessons' | translate) : ('adminCourseManagement.lesson' | translate) }} (€) *
                  </label>
                  <input type="number" id="newLessonPrice" [(ngModel)]="newLessonOption.price" name="newLessonPrice"
                    min="0" step="0.01" class="form-control" placeholder="0.00">
                </div>

                <div class="form-group">
                  <button type="button" class="btn btn-secondary btn-sm lesson-add-btn" (click)="addLessonOptionToNewSchedule()">
                    <span class="btn-icon">+</span>
                    {{ 'adminCourseManagement.addLessonOption' | translate }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Current Lesson Options for New Schedule -->
            <div *ngIf="newSchedule.lessonOptions.length > 0" class="current-lesson-options styled-list">
              <h6>{{ 'adminCourseManagement.currentLessonOptions' | translate }} ({{ newSchedule.lessonOptions.length }})</h6>
              <div class="lesson-options-list">
                <div *ngFor="let option of newSchedule.lessonOptions; let i = index" class="lesson-option-item styled-item">
                  <span class="lesson-option-text">
                    {{ option.lessonCount }} {{ option.lessonCount === 1 ? ('adminCourseManagement.lesson' | translate) : ('adminCourseManagement.lessons' | translate) }} - €{{ option.price }}
                  </span>
                  <button type="button" class="btn btn-danger btn-xs" (click)="removeLessonOptionFromNewSchedule(i)">×</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Add Schedule Button -->
          <div class="add-schedule-actions">
            <button type="button" class="btn btn-primary add-schedule-btn" (click)="addSchedule()"
              [disabled]="!newSchedule.startTime || !newSchedule.endTime || newSchedule.lessonOptions.length === 0">
              <span class="btn-icon">+</span>
              {{ 'adminCourseManagement.addThisSchedule' | translate }}
            </button>
          </div>
        </div>

        <!-- Current Schedules -->
        <div *ngIf="courseForm.schedules.length > 0" class="current-schedules-section styled-schedules">
          <h4>{{ 'adminCourseManagement.currentSchedules' | translate }} ({{ courseForm.schedules.length }})</h4>
          <div class="schedules-list">
            <div *ngFor="let schedule of courseForm.schedules; let scheduleIndex = index" class="schedule-card styled-card">
              <div class="schedule-header">
                <h5 class="schedule-title">{{ getScheduleDisplay(schedule) }}</h5>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeSchedule(scheduleIndex)">
                  <span class="btn-icon">🗑️</span>
                  {{ 'adminCourseManagement.remove' | translate }}
                </button>
              </div>

              <div class="schedule-lessons">
                <h6>{{ 'adminCourseManagement.lessonOptions' | translate }} ({{ schedule.lessonOptions.length }})</h6>

                <!-- Existing Lesson Options -->
                <div class="lesson-options-grid">
                  <div *ngFor="let lessonOption of schedule.lessonOptions; let lessonIndex = index" class="lesson-option-editor styled-editor">
                    <div class="lesson-option-controls">
                      <div class="control-group">
                        <label>{{ 'adminCourseManagement.lessons' | translate }}</label>
                        <select [(ngModel)]="lessonOption.lessonCount" [name]="'lessonCount_' + scheduleIndex + '_' + lessonIndex"
                          (ngModelChange)="updateLessonOption(scheduleIndex, lessonIndex, 'lessonCount', $event)" class="form-control form-control-sm">
                          <option *ngFor="let count of getLessonCountOptions()" [value]="count">{{ count }}</option>
                        </select>
                      </div>

                      <div class="control-group">
                        <label>{{ 'adminCourseManagement.pricePerStudent' | translate }}</label>
                        <input type="number" [(ngModel)]="lessonOption.price" [name]="'lessonPrice_' + scheduleIndex + '_' + lessonIndex"
                          (ngModelChange)="updateLessonOption(scheduleIndex, lessonIndex, 'price', $event)" min="0" step="0.01" class="form-control form-control-sm">
                      </div>

                      <div class="control-group">
                        <button type="button" class="btn btn-danger btn-xs" (click)="removeLessonOptionFromSchedule(scheduleIndex, lessonIndex)">×</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add Lesson Option to Existing Schedule -->
                <button type="button" class="btn btn-secondary btn-sm lesson-add-btn" (click)="addLessonOptionToSchedule(scheduleIndex)">
                  <span class="btn-icon">+</span>
                  {{ 'adminCourseManagement.addLessonOption' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- No Schedules Warning -->
        <div *ngIf="courseForm.schedules.length === 0" class="no-schedules-warning styled-warning">
          <p>⚠️ {{ 'adminCourseManagement.noSchedulesWarning' | translate }}</p>
        </div>

        <!-- Course Summary -->
        <div *ngIf="courseForm.schedules.length > 0 && courseForm.groupPricing.length > 0" class="form-section">
          <h3 class="section-title">{{ 'adminCourseManagement.courseSummary' | translate }}</h3>
          <div class="course-summary-preview">
            <div class="summary-section">
              <h4>{{ 'adminCourseManagement.groupPricing' | translate }}</h4>
              <div class="summary-grid">
                <div *ngFor="let groupPricing of courseForm.groupPricing" class="summary-item">
                  <span class="summary-label">{{ groupPricing.studentRange }} {{ 'adminCourseManagement.students' | translate }}</span>
                  <span class="summary-price">€{{ groupPricing.price }}
                    /{{ 'adminCourseManagement.student' | translate }}</span>
                </div>
              </div>
            </div>

            <div class="summary-section">
              <h4>{{ 'adminCourseManagement.schedulesAndLessonOptions' | translate }}</h4>
              <div *ngFor="let schedule of courseForm.schedules; let i = index" class="schedule-summary">
                <h5>{{ getScheduleDisplay(schedule) }}</h5>
                <div class="lesson-summary-grid">
                  <div *ngFor="let option of schedule.lessonOptions" class="lesson-summary-item">
                    <span>{{ option.lessonCount }} {{ option.lessonCount > 1 ? ('adminCourseManagement.lessons' | translate) : ('adminCourseManagement.lesson' | translate) }}: €{{ option.price }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()" [disabled]="isLoading">
            {{ 'adminCourseManagement.cancel' | translate }}
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="isFormInvalid()">
            <span *ngIf="isLoading" class="loading-spinner"></span>
            {{ editingCourse ? ('adminCourseManagement.updateCourse' | translate) : ('adminCourseManagement.createCourse' | translate) }}
          </button>
        </div>
      </form>
    </div>

    <!-- Filters and Search -->
    <!-- <div class="filters-container">
      <div class="search-section">
        <div class="search-group">
          <label for="searchTerm">{{ 'adminCourseManagement.search' | translate }}</label>
          <input type="text" id="searchTerm" [(ngModel)]="searchTerm"
            placeholder="{{ 'adminCourseManagement.searchPlaceholder' | translate }}" class="form-control search-input">
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label for="statusFilter">{{ 'adminCourseManagement.filterByStatus' | translate }}</label>
          <select id="statusFilter" [(ngModel)]="statusFilter" class="form-control">
            <option value="all">{{ 'adminCourseManagement.allStatuses' | translate }}</option>
            <option value="active">{{ 'adminCourseManagement.active' | translate }}</option>
            <option value="completed">{{ 'adminCourseManagement.completed' | translate }}</option>
            <option value="cancelled">{{ 'adminCourseManagement.cancelled' | translate }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="clientFilter">{{ 'adminCourseManagement.filterByClient' | translate }}</label>
          <select id="clientFilter" [(ngModel)]="clientFilter" class="form-control">
            <option value="all">{{ 'adminCourseManagement.allClients' | translate }}</option>
            <option *ngFor="let client of clientOptions" [value]="client">{{ client }}</option>
          </select>
        </div>
      </div>
    </div> -->

    <!-- Courses List -->
    <div class="courses-container">
      <div *ngIf="isLoading && courses.length === 0" class="loading-container">
        <div class="loading-spinner-large"></div>
        <p>{{ 'adminCourseManagement.loadingCourses' | translate }}</p>
      </div>

      <div *ngIf="!isLoading && filteredCourses.length === 0" class="empty-state">
        <div class="empty-icon">📚</div>
        <h3>{{ 'adminCourseManagement.noCourses' | translate }}</h3>
        <p>{{ 'adminCourseManagement.noCoursesMessage' | translate }}</p>
      </div>

      <div *ngIf="filteredCourses.length > 0" class="courses-grid">
        <div *ngFor="let course of filteredCourses" class="course-card">
          <!-- Course Header -->
          <div class="course-header">
            <div class="course-title-section">
              <h3 class="course-title">{{ course.name }}</h3>
              <span class="course-code">{{ course.courseCode }}</span>
            </div>
          </div>

          <!-- Course Details -->
          <div class="course-details">
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.client' | translate }}:</span>
              <span class="detail-value">{{ course.clientName }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.professional' | translate }}:</span>
              <span class="detail-value">{{ getProfessionalName(course.professionalId) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.duration' | translate }}:</span>
              <span class="detail-value">
                {{ course.startDate | date:'mediumDate' }} - {{ course.endDate | date:'mediumDate' }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.enrollment' | translate }}:</span>
              <span class="detail-value">{{ course.currentStudents }}/{{ course.maxStudents }} {{ 'adminCourseManagement.students' | translate }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.schedules' | translate }}:</span>
              <span class="detail-value">{{ getTotalSchedulesCount(course) }} {{ 'adminCourseManagement.schedules' | translate | lowercase }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">{{ 'adminCourseManagement.totalLessonOptions' | translate }}:</span>
              <span class="detail-value">{{ getTotalLessonOptionsCount(course) }} {{ 'adminCourseManagement.options' | translate }}</span>
            </div>
          </div>

          <!-- Course Description -->
          <div class="course-description">
            <p>{{ course.description }}</p>
          </div>

          <!-- Group Pricing Preview -->
          <div class="group-pricing-preview">
            <h4>{{ 'adminCourseManagement.groupPricing' | translate }}</h4>
            <div class="group-pricing-display">
              <div class="group-pricing-item">{{ getGroupPricingDisplay(course) }}</div>
            </div>
          </div>

          <!-- Schedules Preview -->
          <div class="schedules-preview">
            <h4>{{ 'adminCourseManagement.schedules' | translate }} ({{ getTotalSchedulesCount(course) }})</h4>
            <div class="schedules-preview-list">
              <div *ngFor="let schedule of course.schedules?.slice(0, 2)" class="schedule-preview-item">
                <div class="schedule-time">{{ getScheduleDisplay(schedule) }}</div>
                <div class="schedule-lessons-count">{{ schedule.lessonOptions.length || 0 }} {{ 'adminCourseManagement.lessonOptions' | translate | lowercase }}</div>
              </div>
              <div *ngIf="getTotalSchedulesCount(course) > 2" class="schedule-more">
                +{{ getTotalSchedulesCount(course) - 2 }} {{ 'adminCourseManagement.moreSchedules' | translate }}
              </div>
            </div>
          </div>

          <!-- Course Actions -->
          <div class="course-actions">
            <button class="btn btn-secondary btn-sm" (click)="editCourse(course)" [disabled]="isLoading">
              <span class="btn-icon">✏️</span>
              {{ 'adminCourseManagement.edit' | translate }}
            </button>
            <button class="btn btn-danger btn-sm" (click)="deleteCourse(course)" [disabled]="isLoading">
              <span class="btn-icon">🗑️</span>
              {{ 'adminCourseManagement.delete' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Course Template Selection Modal -->
<div *ngIf="showTemplateSelection" class="modal-overlay" (click)="hideCourseTemplateSelection()">
  <div class="modal-content template-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ 'adminCourseManagement.selectCourseTemplate' | translate }}</h2>
      <button class="modal-close" (click)="hideCourseTemplateSelection()">×</button>
    </div>

    <div class="modal-body">
      <p class="template-instruction">
        {{ 'adminCourseManagement.templateInstruction' | translate }}
      </p>

      <div class="template-courses-grid">
        <div *ngFor="let course of courses" class="template-course-card" (click)="applyCourseTemplate(course)">
          <div class="template-course-header">
            <h4>{{ course.name }}</h4>
          </div>

          <div class="template-course-details">
            <p><strong>{{ 'adminCourseManagement.client' | translate }}:</strong> {{ course.clientName }}</p>
            <p><strong>{{ 'adminCourseManagement.professional' | translate }}:</strong> {{ getProfessionalName(course.professionalId) }}</p>
            <p><strong>{{ 'adminCourseManagement.schedules' | translate }}:</strong> {{ getTotalSchedulesCount(course) }}</p>
            <p><strong>{{ 'adminCourseManagement.groupPricing' | translate }}:</strong> {{ getGroupPricingDisplay(course) }}</p>
          </div>

          <div class="template-course-description">
            <p>{{ course.description | slice:0:100 }}{{ course.description.length > 100 ? '...' : '' }}</p>
          </div>

          <div class="template-apply-btn">
            <span class="btn-text">{{ 'adminCourseManagement.clickToUseTemplate' | translate }}</span>
          </div>
        </div>
      </div>

      <div *ngIf="courses.length === 0" class="no-templates">
        <p>{{ 'adminCourseManagement.noTemplatesAvailable' | translate }}</p>
      </div>
    </div>
  </div>
</div>